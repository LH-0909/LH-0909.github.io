<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é©¬å…‹æ€ä¸»ä¹‰åŸç† - åˆ†å•å…ƒåˆ·é¢˜ç³»ç»Ÿ</title>
    <style>
        :root { --primary: #4776E6; --primary-dark: #8E54E9; --wrong: #FF512F; --correct: #02b3e4; --bg: #f5f7fa; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: #333; height: 100vh; display: flex; flex-direction: column; }
        
        /* å¯¼èˆªæ  */
        .navbar { background: linear-gradient(to right, var(--primary), var(--primary-dark)); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 100; }
        .nav-title { font-weight: bold; font-size: 1.1rem; }
        .nav-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }

        /* ä¸»å®¹å™¨ */
        .container { flex: 1; overflow-y: auto; padding: 20px; max-width: 800px; margin: 0 auto; width: 100%; }

        /* é¦–é¡µï¼šå•å…ƒé€‰æ‹© */
        #home-view { display: grid; gap: 15px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
        .unit-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.2s; border-left: 5px solid var(--primary); }
        .unit-card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .unit-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; }
        .unit-info { font-size: 0.85rem; color: #666; }
        .wrong-book-card { border-left-color: var(--wrong); background: #fff5f5; }

        /* ç­”é¢˜é¡µ */
        #quiz-view { display: none; }
        .quiz-header { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; }
        .progress-pill { background: #e0e7ff; color: var(--primary); padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; }
        
        .question-card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .q-type { display: inline-block; background: var(--primary); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; vertical-align: middle; margin-right: 5px; }
        .q-text { font-size: 1.1rem; line-height: 1.6; font-weight: 500; }

        .options-list { display: flex; flex-direction: column; gap: 12px; margin-top: 20px; }
        .option-item { display: flex; padding: 15px; border: 2px solid #f0f0f0; border-radius: 10px; cursor: pointer; transition: 0.2s; align-items: center; background: white; }
        .option-item:hover { background: #fafafa; border-color: #ddd; }
        .option-item.selected { border-color: var(--primary); background: #f0f7ff; }
        .option-tag { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; background: #eee; border-radius: 50%; margin-right: 15px; font-weight: bold; font-size: 0.9rem; flex-shrink: 0; }
        
        /* ç»“æœæ ·å¼ */
        .option-item.correct { border-color: var(--correct); background: #e6fffa; }
        .option-item.correct .option-tag { background: var(--correct); color: white; }
        .option-item.wrong { border-color: var(--wrong); background: #fff5f5; }
        .option-item.wrong .option-tag { background: var(--wrong); color: white; }

        .analysis-box { background: #f8f9fa; border-radius: 8px; padding: 15px; margin-top: 20px; display: none; border-left: 4px solid #ccc; animation: fadeIn 0.3s; }
        .analysis-box.show { display: block; }
        .analysis-box.correct { border-color: var(--correct); }
        .analysis-box.wrong { border-color: var(--wrong); }
        
        /* åº•éƒ¨æ§åˆ¶æ  */
        .controls { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px 20px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); display: flex; gap: 10px; z-index: 90; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .btn-prev { background: #f0f0f0; color: #555; flex: 0.5; }
        .btn-submit { background: var(--primary); color: white; flex: 2; box-shadow: 0 4px 10px rgba(71, 118, 230, 0.3); }
        .btn-next { background: #f0f0f0; color: #555; flex: 0.5; }
        .btn:active { transform: scale(0.98); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* é”™é¢˜æœ¬ä¸ºç©º */
        .empty-state { text-align: center; padding: 50px 20px; color: #888; }
    </style>
</head>
<body>

    <div class="navbar">
        <div class="nav-title" id="page-title">é©¬å…‹æ€ä¸»ä¹‰åˆ·é¢˜ç³»ç»Ÿ</div>
        <button class="nav-btn" onclick="showHome()">è¿”å›ä¸»é¡µ</button>
    </div>

    <div class="container" id="main-container">
        <div id="home-view">
            </div>

        <div id="quiz-view">
            <div class="quiz-header">
                <div class="progress-pill" id="quiz-progress">1 / 100</div>
                <div style="font-size:0.85rem; color:#666;" id="unit-name-display"></div>
            </div>
            
            <div class="question-card">
                <div>
                    <span class="q-type" id="q-type">å•é€‰</span>
                    <span class="q-text" id="q-text">é¢˜ç›®å†…å®¹åŠ è½½ä¸­...</span>
                </div>
            </div>

            <div class="options-list" id="options-container">
                </div>

            <div class="analysis-box" id="analysis-box">
                <div style="font-weight:bold; margin-bottom:5px;" id="result-title"></div>
                <div>æ­£ç¡®ç­”æ¡ˆï¼š<span id="correct-ans" style="font-weight:bold; color:var(--primary);"></span></div>
                <div>ä½ çš„é€‰æ‹©ï¼š<span id="user-ans"></span></div>
            </div>
            
            <div style="height: 80px;"></div>
        </div>
    </div>

    <div class="controls" id="controls" style="display:none;">
        <button class="btn btn-prev" onclick="app.prevQuestion()">ä¸Šä¸€é¢˜</button>
        <button class="btn btn-submit" id="submit-btn" onclick="app.submitAnswer()">æäº¤ç­”æ¡ˆ</button>
        <button class="btn btn-next" onclick="app.nextQuestion()">ä¸‹ä¸€é¢˜</button>
    </div>

    <script src="questions.js"></script>

    <script>
        const app = {
            currentUnit: null,
            currentIndex: 0,
            questionList: [],
            wrongBook: JSON.parse(localStorage.getItem('marx_wrong_book') || '[]'),
            
            init() {
                this.renderHome();
            },

            // æ¸²æŸ“é¦–é¡µ
            renderHome() {
                document.getElementById('home-view').style.display = 'grid';
                document.getElementById('quiz-view').style.display = 'none';
                document.getElementById('controls').style.display = 'none';
                document.getElementById('page-title').innerText = "é€‰æ‹©ç»ƒä¹ å•å…ƒ";

                const container = document.getElementById('home-view');
                container.innerHTML = '';

                // æ¸²æŸ“6ä¸ªå•å…ƒ
                if (typeof QUESTION_DATABASE !== 'undefined') {
                    for (const [key, unit] of Object.entries(QUESTION_DATABASE)) {
                        const div = document.createElement('div');
                        div.className = 'unit-card';
                        div.onclick = () => this.startQuiz(key);
                        div.innerHTML = `
                            <div class="unit-title">${unit.name}</div>
                            <div class="unit-info">å…± ${unit.questions.length} é“é¢˜</div>
                        `;
                        container.appendChild(div);
                    }
                } else {
                    container.innerHTML = '<div style="padding:20px; color:red;">é”™è¯¯ï¼šæœªæ‰¾åˆ° questions.js æ•°æ®æ–‡ä»¶ã€‚è¯·ç¡®ä¿ Python è„šæœ¬å·²è¿è¡Œï¼Œä¸” questions.js ä¸æœ¬æ–‡ä»¶åœ¨åŒä¸€ç›®å½•ã€‚</div>';
                }

                // é”™é¢˜æœ¬å…¥å£
                const wrongDiv = document.createElement('div');
                wrongDiv.className = 'unit-card wrong-book-card';
                wrongDiv.onclick = () => this.startWrongMode();
                wrongDiv.innerHTML = `
                    <div class="unit-title">ğŸ“– å…¨å±€é”™é¢˜æœ¬</div>
                    <div class="unit-info">å½“å‰ç´¯è®¡é”™é¢˜ï¼š${this.wrongBook.length} é“</div>
                `;
                container.appendChild(wrongDiv);
            },

            // å¼€å§‹å•å…ƒç»ƒä¹ 
            startQuiz(unitKey) {
                this.currentUnit = unitKey;
                this.questionList = QUESTION_DATABASE[unitKey].questions;
                this.currentIndex = 0;
                
                // è¯»å–ä¸Šæ¬¡è¿›åº¦
                const savedIndex = localStorage.getItem(`progress_${unitKey}`);
                if (savedIndex) this.currentIndex = parseInt(savedIndex);
                if (this.currentIndex >= this.questionList.length) this.currentIndex = 0;

                this.enterQuizMode(QUESTION_DATABASE[unitKey].name);
            },

            // å¼€å§‹é”™é¢˜æ¨¡å¼
            startWrongMode() {
                if (this.wrongBook.length === 0) {
                    alert("é”™é¢˜æœ¬æ˜¯ç©ºçš„ï¼å…ˆå»åˆ·é¢˜å§ã€‚");
                    return;
                }
                
                // ä»æ‰€æœ‰å•å…ƒä¸­æœé›†é”™é¢˜è¯¦æƒ…
                let allQs = [];
                for (const unit of Object.values(QUESTION_DATABASE)) {
                    allQs = allQs.concat(unit.questions);
                }
                
                // è¿‡æ»¤å‡ºåœ¨é”™é¢˜æœ¬é‡Œçš„é¢˜
                this.questionList = allQs.filter(q => this.wrongBook.includes(q.uid));
                this.currentUnit = 'wrong_book';
                this.currentIndex = 0;
                this.enterQuizMode("é”™é¢˜æœ¬ä¸“é¡¹ç»ƒä¹ ");
            },

            enterQuizMode(titleName) {
                document.getElementById('home-view').style.display = 'none';
                document.getElementById('quiz-view').style.display = 'block';
                document.getElementById('controls').style.display = 'flex';
                document.getElementById('page-title').innerText = "æ­£åœ¨ç»ƒä¹ ";
                document.getElementById('unit-name-display').innerText = titleName;
                this.renderQuestion();
            },

            renderQuestion() {
                if (this.questionList.length === 0) {
                    document.getElementById('quiz-view').innerHTML = '<div class="empty-state">ğŸ‰ è¿™é‡Œçš„é¢˜éƒ½åšå®Œäº†ï¼</div>';
                    return;
                }

                const q = this.questionList[this.currentIndex];
                
                // è¿›åº¦æ¡
                document.getElementById('quiz-progress').innerText = `${this.currentIndex + 1} / ${this.questionList.length}`;
                
                // é¢˜ç›®å†…å®¹
                document.getElementById('q-type').innerText = q.type;
                document.getElementById('q-text').innerText = q.title;

                // é€‰é¡¹
                const container = document.getElementById('options-container');
                container.innerHTML = '';
                
                q.options.forEach(opt => {
                    const el = document.createElement('div');
                    el.className = 'option-item';
                    el.dataset.key = opt.k;
                    el.onclick = () => this.selectOption(el, q.type);
                    el.innerHTML = `<span class="option-tag">${opt.k}</span> ${opt.v}`;
                    container.appendChild(el);
                });

                // é‡ç½®çŠ¶æ€
                document.getElementById('analysis-box').className = 'analysis-box';
                const btn = document.getElementById('submit-btn');
                btn.disabled = false;
                btn.innerText = "æäº¤ç­”æ¡ˆ";
                btn.style.opacity = "1";

                // ä¿å­˜è¿›åº¦
                if (this.currentUnit !== 'wrong_book') {
                    localStorage.setItem(`progress_${this.currentUnit}`, this.currentIndex);
                }
            },

            selectOption(el, type) {
                if (document.getElementById('submit-btn').disabled) return;

                if (type === 'å¤šé€‰é¢˜') {
                    el.classList.toggle('selected');
                } else {
                    // å•é€‰äº’æ–¥
                    const siblings = document.getElementById('options-container').children;
                    for (let s of siblings) s.classList.remove('selected');
                    el.classList.add('selected');
                }
            },

            submitAnswer() {
                const q = this.questionList[this.currentIndex];
                const selected = document.querySelectorAll('.option-item.selected');
                
                if (selected.length === 0) return alert("è¯·å…ˆé€‰æ‹©ç­”æ¡ˆ");

                const btn = document.getElementById('submit-btn');
                btn.disabled = true;
                btn.innerText = "å·²æäº¤";
                btn.style.opacity = "0.7";

                // è·å–ç”¨æˆ·ç­”æ¡ˆ
                let userAns = [];
                selected.forEach(el => userAns.push(el.dataset.key));
                userAns = userAns.sort().join('');
                
                // å¤„ç†æ­£ç¡®ç­”æ¡ˆï¼ˆå…¼å®¹ä¸åŒæ ¼å¼ï¼Œå¦‚ "A" æˆ– "ABC"ï¼‰
                let correctAns = q.answer.replace(/\s/g, '').split('').sort().join('');

                const isCorrect = userAns === correctAns;

                // æ˜¾ç¤ºè§£æ
                const box = document.getElementById('analysis-box');
                box.classList.add('show');
                box.classList.add(isCorrect ? 'correct' : 'wrong');
                document.getElementById('result-title').innerText = isCorrect ? "å›ç­”æ­£ç¡®" : "å›ç­”é”™è¯¯";
                document.getElementById('result-title').style.color = isCorrect ? "var(--correct)" : "var(--wrong)";
                document.getElementById('correct-ans').innerText = q.answer;
                document.getElementById('user-ans').innerText = userAns;

                // æŸ“è‰²
                const opts = document.getElementById('options-container').children;
                for (let opt of opts) {
                    const k = opt.dataset.key;
                    if (correctAns.includes(k)) opt.classList.add('correct');
                    if (userAns.includes(k) && !correctAns.includes(k)) opt.classList.add('wrong');
                }

                // å¤„ç†é”™é¢˜æœ¬é€»è¾‘
                if (!isCorrect) {
                    if (!this.wrongBook.includes(q.uid)) {
                        this.wrongBook.push(q.uid);
                        localStorage.setItem('marx_wrong_book', JSON.stringify(this.wrongBook));
                    }
                } else {
                    // å¦‚æœåœ¨é”™é¢˜æ¨¡å¼ä¸‹ç­”å¯¹äº†ï¼Œè¯¢é—®æ˜¯å¦ç§»é™¤
                    if (this.currentUnit === 'wrong_book') {
                        if (confirm("è¿™é“é¢˜ä½ ç­”å¯¹äº†ï¼è¦æŠŠå®ƒä»é”™é¢˜æœ¬ç§»å‡ºå—ï¼Ÿ")) {
                            this.wrongBook = this.wrongBook.filter(id => id !== q.uid);
                            localStorage.setItem('marx_wrong_book', JSON.stringify(this.wrongBook));
                        }
                    }
                }
            },

            nextQuestion() {
                if (this.currentIndex < this.questionList.length - 1) {
                    this.currentIndex++;
                    this.renderQuestion();
                } else {
                    alert("å·²ç»æ˜¯æœ€åä¸€é¢˜äº†");
                }
            },

            prevQuestion() {
                if (this.currentIndex > 0) {
                    this.currentIndex--;
                    this.renderQuestion();
                }
            }
        };

        function showHome() {
            app.renderHome();
        }

        app.init();
    </script>
</body>
</html>